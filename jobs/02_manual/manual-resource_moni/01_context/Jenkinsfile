#!groovy

@Library('jenkins-common-lib') _

 node('master') { timestamps
{
   /** ジョブパラメータ取得ステージ
     * ・
     * ・
     * ・
     * ・
     * ・
     */
    stage('ジョブパラメータ取得')
    {
        try
        {
            // MissingPropertyException回避のため、仮の値（temp）をセット
            def server = 'temp'

            try
            {
                // 応答に制限時間を設定
                timeout(time: 10, unit: 'SECONDS')
                {
                    // ユーザから入力を受け付ける
                    def userInput = input(
                        message        :  '''\
                                     |リソース取得先サーバを選択してください。
                                     |（応答時間：10秒）'''.stripMargin(),
                        ok             : '選択する',
                        parameters     : [
                            choice(
                                name   : 'リソース取得先サーバ名:',
                                choices: 'web/apサーバ\nバッチサーバ'
                            )
                        ]
                    )
                    println 'aaa'
                }
                println 'bb'
            } catch(Exception e)
            {
                // 変数の中身がnullから変わっていない場合は、例外を投げる
                printMsg('error', '応答時間内にリソース取得先サーバを選択してください。')
                throw e
            }
println 'cc'
            // 入力されたデータに合わせて、処理用の値をセット
            if(userInput == 'web/apサーバ')
            {
                server = 'webap'

            } else
            {
                server = 'batch'
            }

            printMsg('info', '変数「server」に「' + userInput + '」がセットされました。')

        } catch(Exception e)
        {
            // 変数の宣言重複ができないことを利用して、引き継いだパラメータで後続ステージに進む
            printMsg('info', '変数「server」に「' + server + '」がセットされました。')
        }
    }
}}
